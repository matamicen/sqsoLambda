CREATE DEFINER=`sqso`@`%` PROCEDURE `qsouserlistget2`(IN IDQRA bigint(20))
BEGIN DROP TEMPORARY TABLE IF EXISTS t_qsos;
/*#Get all the post where the current user is participating.  */
CREATE TEMPORARY TABLE t_qsos (
  select
    *
  from
    (
      (
        SELECT
          qsos.*
        from
          qsos
          INNER JOIN qsos_qras on qsos.idqsos = qsos_qras.idqso
        WHERE
          qsos.datetime <= NOW()
          and qsos_qras.idqra = IDQRA
          and deleted = 0
        LIMIT
          50
      )
      UNION
        #Get all the post where the following users are participating.
        (
          SELECT
            qsos.*
          from
            qsos
            INNER JOIN qsos_qras on qsos.idqsos = qsos_qras.idqso
            INNER JOIN qra_followers on qra_followers.idqra_followed = qsos_qras.idqra
          WHERE
            qsos.datetime <= NOW()
            and qra_followers.idqra = IDQRA
            and deleted = 0
          LIMIT
            50
        )
      order by
        datetime desc
    ) as t_qsos
);
DROP TEMPORARY TABLE IF EXISTS t_qsos1;
DROP TEMPORARY TABLE IF EXISTS t_qsos2;
CREATE TEMPORARY TABLE t_qsos1 (
  select
    *
  from
    t_qsos
);
CREATE TEMPORARY TABLE t_qsos2 (
  select
    *
  from
    t_qsos
);
/*#Get QSO Data and QRA Owner Detail*/
SELECT
  t_qsos1.*,
  qras.idqras,
  qras.qra,
  qras.profilepic,
  qras.avatarpic
FROM
  qras
  INNER JOIN qsos_qras ON qsos_qras.idqra = qras.idqras
  INNER JOIN t_qsos1 as t_qsos1 ON t_qsos1.idqsos = qsos_qras.idqso
WHERE
  isOwner = 1
order by
  idqso desc;
  /*#QRAS*/
SELECT
  *
FROM
  (
    (
      SELECT
        idqso,
        qras.idqras,
        qras.qra,
        qras.profilepic,
        qras.avatarpic
      FROM
        qras
        INNER JOIN qsos_qras ON qsos_qras.idqra = qras.idqras
        INNER JOIN t_qsos1 as t_qsos1 ON t_qsos1.idqsos = qsos_qras.idqso
      WHERE
        isOwner = 0
        and qras.disabled = 0
    )
    UNION
      (
        SELECT
          idqso,
          qras.idqras,
          qras.qra,
          qras.profilepic,
          qras.avatarpic
        FROM
          qras
          INNER JOIN qsos_qras ON qsos_qras.idqra = qras.idqras
          INNER JOIN t_qsos2 as t_qsos2 ON t_qsos2.idqso_shared = qsos_qras.idqso
        WHERE
          isOwner = 0
          and qras.disabled = 0
      )
  ) AS i
ORDER BY
  idqso DESC;
  /*#Comments*/
SELECT
  *
FROM
  (
    (
      SELECT
        qsos_comments.*,
        qras.idqras,
        qras.qra,
        qras.profilepic,
        qras.avatarpic
      from
        qsos_comments
        inner join t_qsos1 as t_qsos1 ON t_qsos1.idqsos = qsos_comments.idqso
        inner join qras ON qsos_comments.idqra = qras.idqras
      where
        qsos_comments.deleted = 0
        and qras.disabled = 0
    )
    UNION
      (
        SELECT
          qsos_comments.*,
          qras.idqras,
          qras.qra,
          qras.profilepic,
          qras.avatarpic
        from
          qsos_comments
          inner join t_qsos2 as t_qsos2 ON t_qsos2.idqso_shared = qsos_comments.idqso
          inner join qras ON qsos_comments.idqra = qras.idqras
        where
          qsos_comments.deleted = 0
          and qras.disabled = 0
      )
  ) AS i
ORDER BY
  idqso DESC,
  idqsos_comments ASC;
  /*#Likes*/
SELECT
  *
FROM
  (
    (
      SELECT
        qsos_likes.*
      from
        qsos_likes
        inner join t_qsos1 as t_qsos1 ON t_qsos1.idqsos = qsos_likes.idqso
    )
    UNION
      (
        SELECT
          qsos_likes.*
        from
          qsos_likes
          inner join t_qsos2 as t_qsos2 ON t_qsos2.idqso_shared = qsos_likes.idqso
      )
  ) AS i
ORDER BY
  idqso DESC;
  /*#Media*/
SELECT
  *
FROM
  (
    (
      SELECT
        qsos_media.*
      from
        qsos_media
        inner join t_qsos1 as t_qsos1 ON t_qsos1.idqsos = qsos_media.idqso
      where
        qsos_media.deleted = 0
    )
    UNION
      (
        SELECT
          qsos_media.*
        from
          qsos_media
          inner join t_qsos2 as t_qsos2 ON t_qsos2.idqso_shared = qsos_media.idqso
        where
          qsos_media.deleted = 0
      )
  ) AS i
ORDER BY
  idqso DESC;
  /*#QSO Original with QRA Owner Data*/
SELECT
  qsos.*,
  qras.idqras,
  qras.qra,
  qras.profilepic,
  qras.avatarpic
FROM
  qras
  INNER JOIN qsos_qras ON qsos_qras.idqra = qras.idqras
  INNER JOIN t_qsos2 as t_qsos2 ON t_qsos2.idqso_SHARED = qsos_qras.idqso
  INNER JOIN qsos on qsos.idqsos = t_qsos2.idqso_shared
WHERE
  isOwner = 1
  and qras.disabled = 0
order by
  idqsos;
  /*#Links*/
SELECT
  *
FROM
  (
    (
      SELECT
                  qsos_links.idqsos_links,
          qsos_links.idqso,
          qsos_links.idqso_rel,
        qsos.*,
        qras.idqras,
        qras.qra,
        qras.profilepic,
        qras.avatarpic
      from
        qsos_links
        inner join qsos on qsos.idqsos = qsos_links.idqso_rel
        INNER JOIN qsos_qras ON qsos.idqsos = qsos_qras.idqso
        inner join qras on qsos_qras.idqra = qras.idqras
        inner join t_qsos1 as t_qsos1 ON t_qsos1.idqsos = qsos_links.idqso
      where
        qsos_qras.isOwner = 1
        and qras.disabled = 0
    )
    UNION
      (
        SELECT
                    qsos_links.idqsos_links,
          qsos_links.idqso,
          qsos_links.idqso_rel,
          qsos.*,
          qras.idqras,
          qras.qra,
          qras.profilepic,
          qras.avatarpic
        from
          qsos_links
          inner join qsos on qsos.idqsos = qsos_links.idqso_rel
          INNER JOIN qsos_qras ON qsos.idqsos = qsos_qras.idqso
          inner join qras on qsos_qras.idqra = qras.idqras
          inner join t_qsos2 as t_qsos2 ON t_qsos2.idqso_shared = qsos_links.idqso
        where
          qsos_qras.isOwner = 1
          and qras.disabled = 0
      )
  ) AS i
ORDER BY
  idqso DESC;
END